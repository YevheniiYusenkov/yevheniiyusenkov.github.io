<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0b0f1a;
      --card: rgba(255,255,255,0.08);
      --text: #e8ecff;
      --muted: rgba(232,236,255,0.7);
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: grid;
      place-items: center;
    }
    .app {
      width: min(720px, 100vw);
      height: min(900px, 100vh);
      padding: 16px;
      box-sizing: border-box;
      display: grid;
      gap: 12px;
      grid-template-rows: auto 1fr auto;
    }
    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }
    .title { font-size: 20px; font-weight: 700; }
    .meta { font-size: 12px; color: var(--muted); }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      min-height: 320px;
    }
    canvas { display: block; width: 100%; height: 100%; }
    .overlay {
      position: absolute;
      left: 12px; right: 12px; bottom: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .btn {
      appearance: none;
      border: 0;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.14);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }
    .footer {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Mini App: Canvas UI</div>
        <div class="meta" id="meta">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="pill" id="theme">theme</div>
    </div>

    <div class="card" id="card">
      <canvas id="c"></canvas>
      <div class="overlay">
        <button class="btn" id="randomize">üé≤ Randomize</button>
        <button class="btn" id="send">üì§ Send to bot</button>
      </div>
    </div>

    <div class="footer">
      <div class="pill" id="size">size</div>
      <div class="pill">Tap-–¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π UI ‚Ä¢ 60fps</div>
    </div>
  </div>

  <script>
    // 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand(); // —Ä–∞—Å–∫—Ä—ã—Ç—å –ø–æ –≤—ã—Å–æ—Ç–µ
    }

    const metaEl = document.getElementById("meta");
    const themeEl = document.getElementById("theme");
    const sizeEl  = document.getElementById("size");

    // –¢–µ–º–∞/–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
    const user = tg?.initDataUnsafe?.user;
    metaEl.textContent = user
      ? `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}${user.username ? " (@" + user.username + ")" : ""}`
      : "–û—Ç–∫—Ä—ã—Ç–æ –±–µ–∑ initData (–ø—Ä–æ–≤–µ—Ä—å –∑–∞–ø—É—Å–∫ –∏–∑ Telegram)";

    const scheme = tg?.colorScheme || "unknown";
    themeEl.textContent = `scheme: ${scheme}`;

    // 2) Canvas-–≥—Ä–∞—Ñ–∏–∫–∞ (–ø—Ä–æ—Å—Ç–∞—è ‚Äú–ø—É–∑—ã—Ä—å–∫–æ–≤–∞—è‚Äù –∞–Ω–∏–º–∞—Ü–∏—è)
    const canvas = document.getElementById("c");
    const card   = document.getElementById("card");
    const ctx    = canvas.getContext("2d");

    let W = 0, H = 0, dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

    function resize() {
      const r = card.getBoundingClientRect();
      W = Math.floor(r.width);
      H = Math.floor(r.height);
      canvas.width  = Math.floor(W * dpr);
      canvas.height = Math.floor(H * dpr);
      canvas.style.width  = W + "px";
      canvas.style.height = H + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      sizeEl.textContent = `${W}√ó${H}`;
    }
    window.addEventListener("resize", resize);
    resize();

    function rand(min, max) { return min + Math.random() * (max - min); }

    let bubbles = [];
    function seed(n=24) {
      bubbles = Array.from({length: n}, () => ({
        x: rand(0, W), y: rand(0, H),
        r: rand(10, 42),
        vx: rand(-0.6, 0.6), vy: rand(-0.6, 0.6),
        a: rand(0.2, 0.9)
      }));
    }
    seed();

    function tick() {
      ctx.clearRect(0, 0, W, H);

      // —Ñ–æ–Ω-–≥—Ä–∞–¥–∏–µ–Ω—Ç
      const g = ctx.createLinearGradient(0, 0, W, H);
      g.addColorStop(0, "rgba(120, 140, 255, 0.10)");
      g.addColorStop(1, "rgba(20, 220, 180, 0.07)");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);

      // ‚Äú–ø—É–∑—ã—Ä—å–∫–∏‚Äù
      for (const b of bubbles) {
        b.x += b.vx; b.y += b.vy;
        if (b.x < -50) b.x = W + 50;
        if (b.x > W + 50) b.x = -50;
        if (b.y < -50) b.y = H + 50;
        if (b.y > H + 50) b.y = -50;

        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(232, 236, 255, ${0.10 * b.a})`;
        ctx.fill();
        ctx.strokeStyle = `rgba(232, 236, 255, ${0.18 * b.a})`;
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      requestAnimationFrame(tick);
    }
    tick();

    document.getElementById("randomize").onclick = () => seed();

    // 3) –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É (Mini App -> –±–æ—Ç)
    document.getElementById("send").onclick = () => {
      const payload = {
        ts: Date.now(),
        user: user ? { id: user.id, name: user.first_name } : null,
        bubbles: bubbles.length
      };
      if (tg) {
        tg.sendData(JSON.stringify(payload));
        tg.HapticFeedback?.impactOccurred("light");
      } else {
        alert("tg API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–æ—Ç–∫—Ä–æ–π –∏–∑ Telegram)");
      }
    };
  </script>
</body>
</html>
